import pandas as pd
import string
from openpyxl import load_workbook
from openpyxl.styles import PatternFill
import os

def obtener_columna_excel(index: int) -> str:
    """
    Convierte un índice de columna (0, 1, 2, ...) en un nombre de columna estilo Excel (A, B, C, ...).
    """
    letras = string.ascii_uppercase
    nombre_columna = ""
    while index >= 0:
        nombre_columna = letras[index % 26] + nombre_columna
        index = index // 26 - 1
    return nombre_columna

def aplicar_formato_condicional(archivo_reporte: str):
    """
    Aplica formato condicional al archivo de reporte resaltando las diferencias.
    
    Parámetros:
    - archivo_reporte: Ruta al archivo de reporte generado (Excel).
    """
    wb = load_workbook(archivo_reporte)
    ws = wb.active

    # Relleno para las celdas con diferencias
    fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")

    # Aplicar formato condicional en todas las filas donde haya diferencias
    for fila in ws.iter_rows(min_row=2, max_row=ws.max_row, min_col=3, max_col=4):
        for celda in fila:
            if celda.value != 'N/A':
                celda.fill = fill

    # Guardar los cambios
    wb.save(archivo_reporte)
    print(f"Formato condicional aplicado en: {archivo_reporte}")

def obtener_ruta_descargas(nombre_archivo: str) -> str:
    """
    Obtiene la ruta de la carpeta 'Descargas' del usuario y concatena el nombre del archivo.
    
    Parámetros:
    - nombre_archivo: El nombre del archivo (con extensión) que se quiere guardar.
    
    Retorna:
    - La ruta completa donde se guardará el archivo.
    """
    # Obtener la carpeta 'Descargas' del usuario en distintos sistemas operativos
    ruta_descargas = os.path.join(os.path.expanduser("~"), "Downloads")
    return os.path.join(ruta_descargas, nombre_archivo)

def comparar_excel(archivo1: str, archivo2: str, hoja1: str = None, hoja2: str = None, nombre_reporte: str = "reporte_comparacion.xlsx"):
    """
    Compara dos archivos de Excel línea por línea y genera un reporte de las diferencias.
    
    Parámetros:
    - archivo1: Ruta al primer archivo de Excel.
    - archivo2: Ruta al segundo archivo de Excel.
    - hoja1: Nombre de la hoja a comparar en el primer archivo (opcional, por defecto usa la primera hoja).
    - hoja2: Nombre de la hoja a comparar en el segundo archivo (opcional, por defecto usa la primera hoja).
    - nombre_reporte: Nombre del archivo de salida para el reporte de diferencias (formato Excel).
    
    Retorna:
    - Un archivo Excel con las diferencias encontradas entre ambos archivos, guardado en la carpeta "Descargas".
    """
    # Leer los archivos de Excel
    try:
        df1 = pd.read_excel(archivo1, sheet_name=hoja1)
        df2 = pd.read_excel(archivo2, sheet_name=hoja2)
    except ValueError as e:
        print(f"Error al leer los archivos: {e}")
        return

    # Obtener el número máximo de filas y columnas entre ambos archivos
    max_filas = max(df1.shape[0], df2.shape[0])
    max_columnas = max(df1.shape[1], df2.shape[1])

    # Mostrar mensaje si los tamaños no coinciden
    if df1.shape != df2.shape:
        print(f"Advertencia: Los archivos tienen tamaños diferentes. Archivo 1: {df1.shape}, Archivo 2: {df2.shape}")

    # Crear un DataFrame vacío para almacenar las diferencias
    diferencias = pd.DataFrame(columns=["Fila", "Columna (Excel)", "Valor Archivo 1", "Valor Archivo 2"])

    # Comparar cada celda
    for fila in range(max_filas):
        for columna in range(max_columnas):
            # Obtener los valores de cada archivo, si existen (si no, marcar como 'N/A')
            valor1 = df1.iloc[fila, columna] if fila < df1.shape[0] and columna < df1.shape[1] else 'N/A'
            valor2 = df2.iloc[fila, columna] if fila < df2.shape[0] and columna < df2.shape[1] else 'N/A'

            # Si los valores no son iguales, se añade al reporte
            if valor1 != valor2:
                diferencias = diferencias.append({
                    "Fila": fila + 1,  # Mostrar las filas a partir de 1, como en Excel
                    "Columna (Excel)": obtener_columna_excel(columna),
                    "Valor Archivo 1": valor1,
                    "Valor Archivo 2": valor2
                }, ignore_index=True)

    # Obtener la ruta de descarga
    ruta_reporte = obtener_ruta_descargas(nombre_reporte)

    # Guardar el reporte de diferencias en la carpeta "Descargas"
    diferencias.to_excel(ruta_reporte, index=False)
    print(f"Reporte de diferencias guardado en: {ruta_reporte}")

    # Aplicar formato condicional
    aplicar_formato_condicional(ruta_reporte)

    return diferencias

if __name__ == "__main__":
    archivo1 = "archivo1.xlsx"  # Cambiar por la ruta real
    archivo2 = "archivo2.xlsx"  # Cambiar por la ruta real
    comparar_excel(archivo1, archivo2)

